{% extends "base.html" %}

{% block title %}My Bookings{% endblock %}

{% block extra_css %}
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
    /* Bookings Page Styles */
    .booking-card {
        border-radius: 10px;
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(0,0,0,0.08);
    }
    
    .booking-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .booking-card .card-img-top {
        height: 180px;
        object-fit: cover;
    }
    
    .booking-card .property-title {
        font-weight: 700;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }
    
    .booking-card .property-location {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }
    
    .booking-dates {
        background-color: #f8f9fa;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .booking-status {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .status-confirmed {
        background-color: rgba(25, 135, 84, 0.1);
        color: #198754;
    }
    
    .status-pending {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }
    
    .status-cancelled {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }
    
    .status-completed {
        background-color: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
    }
    
    .booking-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .filter-bar {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    
    .booking-empty-state {
        text-align: center;
        padding: 3rem;
        background-color: #f8f9fa;
        border-radius: 10px;
    }
    
    .booking-empty-state img {
        max-width: 150px;
        margin-bottom: 1.5rem;
        opacity: 0.7;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="page-title d-flex justify-content-between align-items-center">
                <div data-aos="fade-right">
                    <h1 class="h3 mb-0">My Bookings</h1>
                    <nav aria-label="breadcrumb" data-aos="fade-right" data-aos-delay="100">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('customer_dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Bookings</li>
                        </ol>
                    </nav>
                </div>
                <div class="d-flex" data-aos="fade-left">
                    <a href="{{ url_for('available_properties') }}" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Find Properties
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Bar -->
<div class="container-fluid mb-4">
    <div class="filter-bar" data-aos="fade-up">
        <div class="row g-2 align-items-center">
            <div class="col-lg-3 col-md-6">
                <label class="form-label small mb-1">Status</label>
                <select class="form-select form-select-sm" id="statusFilter" aria-label="Filter bookings by status">
                    <option value="all">All Statuses</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="pending">Pending</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <div class="col-lg-3 col-md-6">
                <label class="form-label small mb-1">Date Range</label>
                <input type="text" class="form-control form-control-sm flatpickr-date-range" id="dateRangeFilter" placeholder="Select dates" aria-label="Filter by date range">
            </div>
            <div class="col-lg-4 col-md-6">
                <label class="form-label small mb-1">Search</label>
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchBookings" placeholder="Search by property name or location" aria-label="Search bookings">
                </div>
            </div>
            <div class="col-lg-2 col-md-6 d-flex align-items-end">
                <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="resetFilters" aria-label="Reset all filters">
                    <i class="fas fa-redo me-1"></i> Reset
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bookings Content -->
<div class="container-fluid mb-5">
    <div class="row" id="bookingsList" data-aos="fade-up" data-aos-delay="100">
        <!-- Booking Card 1 -->
        <div class="col-md-6 col-lg-4 booking-item" data-status="confirmed">
            <div class="booking-card card h-100">
                <img src="{{ url_for('static', filename='img/properties/apartment1.jpg') }}" class="card-img-top" alt="Modern Apartment">
                <div class="card-body">
                    <span class="booking-status status-confirmed">Confirmed</span>
                    <h5 class="property-title">Modern Apartment</h5>
                    <p class="property-location"><i class="fas fa-map-marker-alt me-2"></i>Downtown, City</p>
                    
                    <div class="booking-dates mb-3">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted d-block">Check-in</small>
                                <strong>Aug 15, 2025</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Check-out</small>
                                <strong>Aug 20, 2025</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold text-primary">$120/night</span>
                        <div class="booking-actions">
                            <a href="{{ url_for('property_detail', property_id=1) }}" class="btn btn-sm btn-outline-primary" aria-label="View property details">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelBookingModal" aria-label="Cancel booking">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white">
                    <small class="text-muted">Booked on July 10, 2025</small>
                </div>
            </div>
        </div>
        
        <!-- Booking Card 2 -->
        <div class="col-md-6 col-lg-4 booking-item" data-status="pending">
            <div class="booking-card card h-100">
                <img src="{{ url_for('static', filename='img/properties/house1.jpg') }}" class="card-img-top" alt="Cozy House">
                <div class="card-body">
                    <span class="booking-status status-pending">Pending</span>
                    <h5 class="property-title">Cozy House</h5>
                    <p class="property-location"><i class="fas fa-map-marker-alt me-2"></i>Suburb Area, City</p>
                    
                    <div class="booking-dates mb-3">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted d-block">Check-in</small>
                                <strong>Jul 20, 2025</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Check-out</small>
                                <strong>Jul 27, 2025</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold text-primary">$95/night</span>
                        <div class="booking-actions">
                            <a href="{{ url_for('property_detail', property_id=2) }}" class="btn btn-sm btn-outline-primary" aria-label="View property details">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelBookingModal" aria-label="Cancel booking">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white">
                    <small class="text-muted">Booked on July 5, 2025</small>
                </div>
            </div>
        </div>
        
        <!-- Booking Card 3 -->
        <div class="col-md-6 col-lg-4 booking-item" data-status="cancelled">
            <div class="booking-card card h-100">
                <img src="{{ url_for('static', filename='img/properties/condo1.jpg') }}" class="card-img-top" alt="Luxury Condo">
                <div class="card-body">
                    <span class="booking-status status-cancelled">Cancelled</span>
                    <h5 class="property-title">Luxury Condo</h5>
                    <p class="property-location"><i class="fas fa-map-marker-alt me-2"></i>Beachfront, City</p>
                    
                    <div class="booking-dates mb-3">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted d-block">Check-in</small>
                                <strong>Jun 10, 2025</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Check-out</small>
                                <strong>Jun 15, 2025</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold text-primary">$150/night</span>
                        <div class="booking-actions">
                            <a href="{{ url_for('property_detail', property_id=3) }}" class="btn btn-sm btn-outline-primary" aria-label="View property details">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white">
                    <small class="text-muted">Cancelled on May 25, 2025</small>
                </div>
            </div>
        </div>
        
        <!-- Empty State (Hidden by default) -->
        <div class="col-12 d-none" id="emptyBookings">
            <div class="booking-empty-state">
                <img src="{{ url_for('static', filename='img/illustrations/empty-bookings.svg') }}" alt="No bookings">
                <h4>No bookings found</h4>
                <p class="text-muted">You don't have any bookings matching your filters.</p>
                <a href="{{ url_for('available_properties') }}" class="btn btn-primary mt-3">
                    <i class="fas fa-search me-2"></i> Find Properties to Book
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Booking Modal -->
<div class="modal fade" id="cancelBookingModal" tabindex="-1" aria-labelledby="cancelBookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelBookingModalLabel">Cancel Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel this booking? This action cannot be undone.</p>
                <form id="cancelBookingForm">
                    <input type="hidden" id="bookingId" name="booking_id">
                    <div class="mb-3">
                        <label for="cancellationReason" class="form-label">Reason for cancellation</label>
                        <select class="form-select" id="cancellationReason" required>
                            <option value="">Select a reason</option>
                            <option value="change_plans">Change of plans</option>
                            <option value="found_alternative">Found an alternative</option>
                            <option value="emergency">Emergency</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3" id="otherReasonContainer" style="display: none;">
                        <label for="otherReason" class="form-label">Please specify</label>
                        <textarea class="form-control" id="otherReason" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="confirmCancelBooking">Cancel Booking</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Review Modal -->
<div class="modal fade" id="addReviewModal" tabindex="-1" aria-labelledby="addReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addReviewModalLabel">Add Your Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reviewForm">
                    <input type="hidden" id="propertyId" name="property_id">
                    <input type="hidden" id="reviewBookingId" name="booking_id">
                    <div class="mb-3 text-center">
                        <label class="form-label">Rating</label>
                        <div class="rating-input">
                            <i class="far fa-star" data-rating="1"></i>
                            <i class="far fa-star" data-rating="2"></i>
                            <i class="far fa-star" data-rating="3"></i>
                            <i class="far fa-star" data-rating="4"></i>
                            <i class="far fa-star" data-rating="5"></i>
                        </div>
                        <input type="hidden" name="rating" id="ratingValue" value="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="reviewTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="reviewTitle" name="title" placeholder="Summarize your experience" required>
                    </div>
                    <div class="mb-3">
                        <label for="reviewContent" class="form-label">Review</label>
                        <textarea class="form-control" id="reviewContent" name="content" rows="4" placeholder="Share details of your experience" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submitReview">Submit Review</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    // Initialize AOS animations
    AOS.init({
        duration: 800,
        easing: 'ease-in-out',
        once: true
    });
    
    // Initialize date range picker
    flatpickr('.flatpickr-date-range', {
        mode: 'range',
        dateFormat: 'Y-m-d',
        altInput: true,
        altFormat: 'F j, Y',
        onChange: function(selectedDates, dateStr, instance) {
            filterBookings();
        }
    });
    
    // Handle status filter change
    document.getElementById('statusFilter').addEventListener('change', function() {
        filterBookings();
    });
    
    // Handle search input
    document.getElementById('searchBookings').addEventListener('input', function() {
        filterBookings();
    });
    
    // Handle reset filters button
    document.getElementById('resetFilters').addEventListener('click', function() {
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('searchBookings').value = '';
        const dateRangePicker = document.querySelector('.flatpickr-date-range')._flatpickr;
        dateRangePicker.clear();
        filterBookings();
    });
    
    // Filter bookings based on selected filters
    function filterBookings() {
        const statusFilter = document.getElementById('statusFilter').value;
        const searchQuery = document.getElementById('searchBookings').value.toLowerCase();
        const bookingItems = document.querySelectorAll('.booking-item');
        let visibleCount = 0;
        
        bookingItems.forEach(function(item) {
            const itemStatus = item.getAttribute('data-status');
            const propertyTitle = item.querySelector('.property-title').textContent.toLowerCase();
            const propertyLocation = item.querySelector('.property-location').textContent.toLowerCase();
            
            let statusMatch = statusFilter === 'all' || itemStatus === statusFilter;
            let searchMatch = searchQuery === '' || 
                             propertyTitle.includes(searchQuery) || 
                             propertyLocation.includes(searchQuery);
            
            if (statusMatch && searchMatch) {
                item.classList.remove('d-none');
                visibleCount++;
            } else {
                item.classList.add('d-none');
            }
        });
        
        // Show/hide empty state
        const emptyState = document.getElementById('emptyBookings');
        if (visibleCount === 0) {
            emptyState.classList.remove('d-none');
        } else {
            emptyState.classList.add('d-none');
        }
    }
    
    // Handle cancellation reason change
    document.getElementById('cancellationReason').addEventListener('change', function() {
        const otherReasonContainer = document.getElementById('otherReasonContainer');
        if (this.value === 'other') {
            otherReasonContainer.style.display = 'block';
        } else {
            otherReasonContainer.style.display = 'none';
        }
    });
    
    // Handle cancel booking confirmation
    document.getElementById('confirmCancelBooking').addEventListener('click', function() {
        const reason = document.getElementById('cancellationReason').value;
        if (!reason) {
            alert('Please select a reason for cancellation');
            return;
        }
        
        if (reason === 'other' && !document.getElementById('otherReason').value.trim()) {
            alert('Please specify your reason for cancellation');
            return;
        }
        
        // Here you would normally send an AJAX request to cancel the booking
        // For demo purposes, we'll just show a success message and close the modal
        alert('Booking cancelled successfully');
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('cancelBookingModal'));
        modal.hide();
        
        // Refresh the page or update the UI
        setTimeout(function() {
            window.location.reload();
        }, 500);
    });
</script>
{% endblock %}
